<div class="animate-fade-in">
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-4xl font-bold text-gray-800 mb-2">Note Tecniche</h1>
        <p class="text-gray-600 text-lg">Gestisci e organizza le tue note, comandi e procedure per tipo</p>
    </div>

    <!-- Loading State -->
    <div *ngIf="loading" class="flex justify-center items-center py-20">
        <mat-spinner></mat-spinner>
    </div>

    <!-- Main Tab Group per i TIPI -->
    <mat-tab-group *ngIf="!loading && noteTypes.length > 0" class="mb-6 main-tab-group" dynamicHeight>

        <!-- Tab per ogni TIPO di nota -->
        <mat-tab *ngFor="let type of noteTypes; trackBy: trackByType" [label]="type">
            <ng-template matTabContent>
                <div class="py-4">
                    <!-- Header del tipo -->
                    <div class="mb-6 flex items-center justify-between type-header">
                        <div class="flex items-center">
                            <mat-icon class="mr-3 text-2xl text-gray-600">{{ getTypeIcon(type) }}</mat-icon>
                            <div>
                                <h2 class="text-2xl font-semibold text-gray-800">{{ type }}</h2>
                                <p class="text-gray-600">Visualizza le note di tipo {{ type.toLowerCase() }}</p>
                            </div>
                        </div>
                        <div class="flex items-center">
                            <span class="px-4 py-2 text-lg font-medium rounded-full {{ getTypeColor(type) }}">
                                {{ getNoteCountByType(type) }} note totali
                            </span>
                        </div>
                    </div>

                    <!-- Sub Tab Group per Più usati/Preferiti/Recenti -->
                    <mat-tab-group dynamicHeight class="nested-tabs">

                        <!-- Sub Tab: Più Utilizzate -->
                        <mat-tab label="Più Utilizzate">
                            <ng-template matTabContent>
                                <div class="py-4">
                                    <div class="mb-4 flex items-center">
                                        <mat-icon class="text-green-600 mr-2">trending_up</mat-icon>
                                        <h3 class="text-lg font-semibold text-gray-700">Le 10 più utilizzate di tipo "{{
                                            type }}"</h3>
                                    </div>

                                    <div *ngIf="getMostUsedByType(type).length > 0; else noNotesMessage"
                                        class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                        <mat-card
                                            *ngFor="let note of getMostUsedByType(type); let i = index; trackBy: trackByNote"
                                            class="cursor-pointer transform transition-all duration-300 hover:scale-105 hover:shadow-lg animate-slide-up"
                                            (click)="openNote(note)">
                                            <mat-card-header class="pb-2">
                                                <div class="flex items-start justify-between w-full">
                                                    <div class="flex-1 min-w-0 mr-2">
                                                        <mat-card-title
                                                            class="text-lg font-semibold text-gray-800 truncate"
                                                            [matTooltip]="note.name">
                                                            {{ note.name }}
                                                        </mat-card-title>
                                                        <mat-card-subtitle class="text-sm text-gray-600 mt-1">
                                                            {{ note.category }} • {{ note.subCategory }}
                                                        </mat-card-subtitle>
                                                    </div>
                                                    <div class="flex flex-col items-end">
                                                        <span
                                                            class="bg-green-100 text-green-800 text-xs font-semibold px-2 py-1 rounded-full mb-1">
                                                            #{{ i + 1 }}
                                                        </span>
                                                        <mat-icon *ngIf="note.isFavorite" class="text-red-500 text-sm"
                                                            matTooltip="Preferita">
                                                            favorite
                                                        </mat-icon>
                                                    </div>
                                                </div>
                                            </mat-card-header>

                                            <mat-card-content class="py-2">
                                                <p *ngIf="note.description"
                                                    class="text-gray-600 text-sm mb-3 line-clamp-2">
                                                    {{ note.description }}
                                                </p>

                                                <div
                                                    class="flex items-center justify-between text-xs text-gray-500 mb-3">
                                                    <span class="flex items-center">
                                                        <mat-icon class="text-xs mr-1">bar_chart</mat-icon>
                                                        {{ note.usageCount }} utilizzi
                                                    </span>
                                                    <span class="flex items-center">
                                                        <mat-icon class="text-xs mr-1">access_time</mat-icon>
                                                        {{ formatDate(note.lastUsed) }}
                                                    </span>
                                                </div>

                                                <!-- Preview del contenuto se presente -->
                                                <div *ngIf="note.freeText" class="bg-gray-50 border rounded p-2 mb-2">
                                                    <pre
                                                        class="text-xs text-gray-700 whitespace-pre-wrap line-clamp-3 font-mono">{{ note.freeText }}</pre>
                                                </div>
                                            </mat-card-content>

                                            <mat-card-actions class="pt-2">
                                                <div class="flex justify-between items-center w-full">
                                                    <mat-chip class="text-xs">{{ note.area }}</mat-chip>
                                                    <div class="flex gap-1">
                                                        <button mat-icon-button matTooltip="Copia contenuto"
                                                            (click)="copyToClipboard(note.freeText || note.description || '', $event)"
                                                            *ngIf="note.freeText">
                                                            <mat-icon class="text-sm">content_copy</mat-icon>
                                                        </button>
                                                        <button mat-icon-button matTooltip="Visualizza nota"
                                                            (click)="openNote(note, $event)">
                                                            <mat-icon class="text-sm">visibility</mat-icon>
                                                        </button>
                                                    </div>
                                                </div>
                                            </mat-card-actions>
                                        </mat-card>
                                    </div>
                                </div>
                            </ng-template>
                        </mat-tab>

                        <!-- Sub Tab: Preferite -->
                        <mat-tab label="Preferite">
                            <ng-template matTabContent>
                                <div class="py-4">
                                    <div class="mb-4 flex items-center">
                                        <mat-icon class="text-red-600 mr-2">favorite</mat-icon>
                                        <h3 class="text-lg font-semibold text-gray-700">Le preferite di tipo "{{ type
                                            }}"</h3>
                                    </div>

                                    <div *ngIf="getFavoritesByType(type).length > 0; else noNotesMessage"
                                        class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                        <mat-card *ngFor="let note of getFavoritesByType(type); trackBy: trackByNote"
                                            class="cursor-pointer transform transition-all duration-300 hover:scale-105 hover:shadow-lg animate-slide-up border-l-4 border-red-500"
                                            (click)="openNote(note)">
                                            <mat-card-header class="pb-2">
                                                <div class="flex items-start justify-between w-full">
                                                    <div class="flex-1 min-w-0 mr-2">
                                                        <mat-card-title
                                                            class="text-lg font-semibold text-gray-800 truncate"
                                                            [matTooltip]="note.name">
                                                            {{ note.name }}
                                                        </mat-card-title>
                                                        <mat-card-subtitle class="text-sm text-gray-600 mt-1">
                                                            {{ note.category }} • {{ note.subCategory }}
                                                        </mat-card-subtitle>
                                                    </div>
                                                    <mat-icon
                                                        class="text-red-500 animate-bounce-gentle">favorite</mat-icon>
                                                </div>
                                            </mat-card-header>

                                            <mat-card-content class="py-2">
                                                <p *ngIf="note.description"
                                                    class="text-gray-600 text-sm mb-3 line-clamp-2">
                                                    {{ note.description }}
                                                </p>

                                                <div
                                                    class="flex items-center justify-between text-xs text-gray-500 mb-3">
                                                    <span class="flex items-center">
                                                        <mat-icon class="text-xs mr-1">bar_chart</mat-icon>
                                                        {{ note.usageCount }} utilizzi
                                                    </span>
                                                    <span class="flex items-center">
                                                        <mat-icon class="text-xs mr-1">access_time</mat-icon>
                                                        {{ formatDate(note.lastUsed) }}
                                                    </span>
                                                </div>

                                                <!-- Preview del contenuto se presente -->
                                                <div *ngIf="note.freeText" class="bg-gray-50 border rounded p-2 mb-2">
                                                    <pre
                                                        class="text-xs text-gray-700 whitespace-pre-wrap line-clamp-3 font-mono">{{ note.freeText }}</pre>
                                                </div>
                                            </mat-card-content>

                                            <mat-card-actions class="pt-2">
                                                <div class="flex justify-between items-center w-full">
                                                    <mat-chip class="text-xs">{{ note.area }}</mat-chip>
                                                    <div class="flex gap-1">
                                                        <button mat-icon-button matTooltip="Copia contenuto"
                                                            (click)="copyToClipboard(note.freeText || note.description || '', $event)"
                                                            *ngIf="note.freeText">
                                                            <mat-icon class="text-sm">content_copy</mat-icon>
                                                        </button>
                                                        <button mat-icon-button matTooltip="Visualizza nota"
                                                            (click)="openNote(note, $event)">
                                                            <mat-icon class="text-sm">visibility</mat-icon>
                                                        </button>
                                                    </div>
                                                </div>
                                            </mat-card-actions>
                                        </mat-card>
                                    </div>
                                </div>
                            </ng-template>
                        </mat-tab>

                        <!-- Sub Tab: Recenti -->
                        <mat-tab label="Recenti">
                            <ng-template matTabContent>
                                <div class="py-4">
                                    <div class="mb-4 flex items-center">
                                        <mat-icon class="text-blue-600 mr-2">schedule</mat-icon>
                                        <h3 class="text-lg font-semibold text-gray-700">Le 10 più recenti di tipo "{{
                                            type }}"</h3>
                                    </div>

                                    <div *ngIf="getRecentByType(type).length > 0; else noNotesMessage"
                                        class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                        <mat-card *ngFor="let note of getRecentByType(type); trackBy: trackByNote"
                                            class="cursor-pointer transform transition-all duration-300 hover:scale-105 hover:shadow-lg animate-slide-up border-l-4 border-blue-500"
                                            (click)="openNote(note)">
                                            <mat-card-header class="pb-2">
                                                <div class="flex items-start justify-between w-full">
                                                    <div class="flex-1 min-w-0 mr-2">
                                                        <mat-card-title
                                                            class="text-lg font-semibold text-gray-800 truncate"
                                                            [matTooltip]="note.name">
                                                            {{ note.name }}
                                                        </mat-card-title>
                                                        <mat-card-subtitle class="text-sm text-gray-600 mt-1">
                                                            {{ note.category }} • {{ note.subCategory }}
                                                        </mat-card-subtitle>
                                                    </div>
                                                    <div class="flex flex-col items-end">
                                                        <mat-icon
                                                            class="text-blue-500 text-sm mb-1">access_time</mat-icon>
                                                        <mat-icon *ngIf="note.isFavorite" class="text-red-500 text-sm"
                                                            matTooltip="Preferita">
                                                            favorite
                                                        </mat-icon>
                                                    </div>
                                                </div>
                                            </mat-card-header>

                                            <mat-card-content class="py-2">
                                                <p *ngIf="note.description"
                                                    class="text-gray-600 text-sm mb-3 line-clamp-2">
                                                    {{ note.description }}
                                                </p>

                                                <div
                                                    class="flex items-center justify-between text-xs text-gray-500 mb-3">
                                                    <span class="flex items-center">
                                                        <mat-icon class="text-xs mr-1">bar_chart</mat-icon>
                                                        {{ note.usageCount }} utilizzi
                                                    </span>
                                                    <span class="flex items-center font-semibold text-blue-600">
                                                        <mat-icon class="text-xs mr-1">schedule</mat-icon>
                                                        {{ formatDate(note.lastUsed) }}
                                                    </span>
                                                </div>

                                                <!-- Preview del contenuto se presente -->
                                                <div *ngIf="note.freeText" class="bg-gray-50 border rounded p-2 mb-2">
                                                    <pre
                                                        class="text-xs text-gray-700 whitespace-pre-wrap line-clamp-3 font-mono">{{ note.freeText }}</pre>
                                                </div>
                                            </mat-card-content>

                                            <mat-card-actions class="pt-2">
                                                <div class="flex justify-between items-center w-full">
                                                    <mat-chip class="text-xs">{{ note.area }}</mat-chip>
                                                    <div class="flex gap-1">
                                                        <button mat-icon-button matTooltip="Copia contenuto"
                                                            (click)="copyToClipboard(note.freeText || note.description || '', $event)"
                                                            *ngIf="note.freeText">
                                                            <mat-icon class="text-sm">content_copy</mat-icon>
                                                        </button>
                                                        <button mat-icon-button matTooltip="Visualizza nota"
                                                            (click)="openNote(note, $event)">
                                                            <mat-icon class="text-sm">visibility</mat-icon>
                                                        </button>
                                                    </div>
                                                </div>
                                            </mat-card-actions>
                                        </mat-card>
                                    </div>
                                </div>
                            </ng-template>
                        </mat-tab>

                    </mat-tab-group>
                </div>
            </ng-template>
        </mat-tab>
    </mat-tab-group>

    <!-- Empty State -->
    <div *ngIf="!loading && noteTypes.length === 0" class="text-center py-16">
        <mat-icon class="text-8xl text-gray-300 mb-6">note_alt</mat-icon>
        <h2 class="text-3xl font-semibold text-gray-600 mb-3">Nessuna nota trovata</h2>
        <p class="text-gray-500 mb-6 text-lg">Inizia creando la tua prima nota tecnica</p>
        <button mat-raised-button color="primary" size="large" routerLink="/note-list">
            <mat-icon>add</mat-icon>
            Crea prima nota
        </button>
    </div>

    <!-- No Notes Message Template -->
    <ng-template #noNotesMessage>
        <div class="text-center py-12">
            <mat-icon class="text-6xl text-gray-300 mb-4">note_alt</mat-icon>
            <h3 class="text-xl font-semibold text-gray-600 mb-2">Nessuna nota trovata</h3>
            <p class="text-gray-500">Non ci sono note disponibili in questa categoria.</p>
        </div>
    </ng-template>
</div>