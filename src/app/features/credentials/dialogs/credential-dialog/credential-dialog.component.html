<h2 mat-dialog-title>{{ isEditMode ? 'Modifica' : 'Nuova' }} Credenziale</h2>

<form [formGroup]="credentialForm" (ngSubmit)="onSubmit()">
    <div mat-dialog-content class="max-h-[80vh] overflow-y-auto">

        <mat-tab-group dynamicHeight>

            <!-- TAB 1: Informazioni Base -->
            <mat-tab label="Informazioni Base">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 py-4">
                    <mat-form-field class="w-full">
                        <mat-label>Nome *</mat-label>
                        <input matInput formControlName="name" required>
                        <mat-error *ngIf="credentialForm.get('name')?.hasError('required')">
                            Il nome è obbligatorio
                        </mat-error>
                    </mat-form-field>

                    <mat-form-field class="w-full">
                        <mat-label>Username *</mat-label>
                        <input matInput formControlName="username" required>
                        <mat-error *ngIf="credentialForm.get('username')?.hasError('required')">
                            L'username è obbligatorio
                        </mat-error>
                    </mat-form-field>

                    <mat-form-field class="w-full">
                        <mat-label>Password *</mat-label>
                        <input matInput [type]="hidePassword ? 'password' : 'text'" formControlName="password" required>
                        <button type="button" mat-icon-button matSuffix (click)="togglePasswordVisibility('password')">
                            <mat-icon>{{hidePassword ? 'visibility_off' : 'visibility'}}</mat-icon>
                        </button>
                        <button type="button" mat-icon-button matSuffix (click)="generatePassword('password')"
                            matTooltip="Genera password">
                            <mat-icon>autorenew</mat-icon>
                        </button>
                        <mat-error *ngIf="credentialForm.get('password')?.hasError('required')">
                            La password è obbligatoria
                        </mat-error>
                    </mat-form-field>

                    <mat-form-field class="w-full">
                        <mat-label>Email</mat-label>
                        <input matInput formControlName="email" type="email">
                        <mat-error *ngIf="credentialForm.get('email')?.hasError('email')">
                            Inserisci un indirizzo email valido
                        </mat-error>
                    </mat-form-field>

                    <mat-form-field class="w-full">
                        <mat-label>URL</mat-label>
                        <input matInput formControlName="url" type="url">
                    </mat-form-field>

                    <mat-form-field class="w-full">
                        <mat-label>Profile</mat-label>
                        <input matInput formControlName="profile">
                    </mat-form-field>

                    <mat-form-field class="w-full md:col-span-2">
                        <mat-label>Descrizione</mat-label>
                        <textarea matInput formControlName="description" rows="3"></textarea>
                    </mat-form-field>
                </div>
            </mat-tab>

            <!-- TAB 2: Profilo e Organizzazione -->
            <mat-tab label="Profilo e Organizzazione">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 py-4">
                    <mat-form-field class="w-full">
                        <mat-label>Subject ID</mat-label>
                        <input matInput formControlName="subject_ID">
                    </mat-form-field>

                    <mat-form-field class="w-full">
                        <mat-label>Nickname</mat-label>
                        <input matInput formControlName="nickname">
                    </mat-form-field>

                    <mat-form-field class="w-full">
                        <mat-label>Operatività</mat-label>
                        <input matInput formControlName="operativity">
                    </mat-form-field>

                    <mat-form-field class="w-full">
                        <mat-label>Area</mat-label>
                        <input matInput formControlName="area">
                    </mat-form-field>

                    <mat-form-field class="w-full">
                        <mat-label>Sezione</mat-label>
                        <input matInput formControlName="section">
                    </mat-form-field>

                    <mat-form-field class="w-full">
                        <mat-label>User Admin</mat-label>
                        <input matInput formControlName="user_Admin">
                    </mat-form-field>

                    <mat-form-field class="w-full">
                        <mat-label>Numero Cliente</mat-label>
                        <input matInput formControlName="numero_Cliente">
                    </mat-form-field>

                    <mat-form-field class="w-full">
                        <mat-label>Frase Identificativa</mat-label>
                        <input matInput formControlName="frase_Identificativa">
                    </mat-form-field>
                </div>
            </mat-tab>

            <!-- TAB 3: Password Aggiuntive -->
            <mat-tab label="Password Aggiuntive">
                <div class="grid grid-cols-1 gap-4 py-4">
                    <mat-form-field class="w-full">
                        <mat-label>Password Primo Accesso</mat-label>
                        <input matInput [type]="hidePasswordFirst ? 'password' : 'text'"
                            formControlName="password_First">
                        <button type="button" mat-icon-button matSuffix
                            (click)="togglePasswordVisibility('password_First')">
                            <mat-icon>{{hidePasswordFirst ? 'visibility_off' : 'visibility'}}</mat-icon>
                        </button>
                        <button type="button" mat-icon-button matSuffix (click)="generatePassword('password_First')"
                            matTooltip="Genera password">
                            <mat-icon>autorenew</mat-icon>
                        </button>
                    </mat-form-field>

                    <mat-form-field class="w-full">
                        <mat-label>Password Admin</mat-label>
                        <input matInput [type]="hidePasswordAdmin ? 'password' : 'text'"
                            formControlName="password_Admin">
                        <button type="button" mat-icon-button matSuffix
                            (click)="togglePasswordVisibility('password_Admin')">
                            <mat-icon>{{hidePasswordAdmin ? 'visibility_off' : 'visibility'}}</mat-icon>
                        </button>
                        <button type="button" mat-icon-button matSuffix (click)="generatePassword('password_Admin')"
                            matTooltip="Genera password">
                            <mat-icon>autorenew</mat-icon>
                        </button>
                    </mat-form-field>

                    <mat-form-field class="w-full">
                        <mat-label>Password 3D Secure</mat-label>
                        <input matInput [type]="hidePassword3DSecure ? 'password' : 'text'"
                            formControlName="password_3D_Secure">
                        <button type="button" mat-icon-button matSuffix
                            (click)="togglePasswordVisibility('password_3D_Secure')">
                            <mat-icon>{{hidePassword3DSecure ? 'visibility_off' : 'visibility'}}</mat-icon>
                        </button>
                        <button type="button" mat-icon-button matSuffix (click)="generatePassword('password_3D_Secure')"
                            matTooltip="Genera password">
                            <mat-icon>autorenew</mat-icon>
                        </button>
                    </mat-form-field>

                    <mat-form-field class="w-full">
                        <mat-label>Password Dispositiva</mat-label>
                        <input matInput [type]="hidePasswordDispositiva ? 'password' : 'text'"
                            formControlName="password_Dispositiva">
                        <button type="button" mat-icon-button matSuffix
                            (click)="togglePasswordVisibility('password_Dispositiva')">
                            <mat-icon>{{hidePasswordDispositiva ? 'visibility_off' : 'visibility'}}</mat-icon>
                        </button>
                        <button type="button" mat-icon-button matSuffix
                            (click)="generatePassword('password_Dispositiva')" matTooltip="Genera password">
                            <mat-icon>autorenew</mat-icon>
                        </button>
                    </mat-form-field>

                    <mat-form-field class="w-full">
                        <mat-label>Storico Password</mat-label>
                        <textarea matInput formControlName="password_History" rows="4"
                            placeholder="Lista delle password precedenti (una per riga)"></textarea>
                    </mat-form-field>
                </div>
            </mat-tab>

            <!-- TAB 4: Dispositivi e SIM -->
            <mat-tab label="Dispositivi e SIM">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 py-4">
                    <div class="md:col-span-2">
                        <h4 class="text-lg font-medium mb-4 text-gray-700">Informazioni Smartphone</h4>
                    </div>

                    <mat-form-field class="w-full">
                        <mat-label>Modello Smartphone</mat-label>
                        <input matInput formControlName="smartPhone_Model">
                    </mat-form-field>

                    <mat-form-field class="w-full">
                        <mat-label>Seriale Smartphone</mat-label>
                        <input matInput formControlName="smartPhone_Serial">
                    </mat-form-field>

                    <mat-form-field class="w-full">
                        <mat-label>IMEI Smartphone</mat-label>
                        <input matInput formControlName="smartPhone_IMEI">
                    </mat-form-field>

                    <mat-form-field class="w-full">
                        <mat-label>Fornitore Smartphone</mat-label>
                        <input matInput formControlName="smartPhone_Supplier">
                    </mat-form-field>

                    <div class="md:col-span-2">
                        <h4 class="text-lg font-medium mb-4 mt-6 text-gray-700">Informazioni SIM</h4>
                    </div>

                    <mat-form-field class="w-full">
                        <mat-label>Seriale SIM</mat-label>
                        <input matInput formControlName="sim_Serial">
                    </mat-form-field>

                    <mat-form-field class="w-full">
                        <mat-label>Operatore SIM</mat-label>
                        <input matInput formControlName="sim_Operator">
                    </mat-form-field>
                </div>
            </mat-tab>

            <!-- TAB 5: Bancario e Pagamenti -->
            <mat-tab label="Bancario e Pagamenti">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 py-4">
                    <mat-form-field class="w-full md:col-span-2">
                        <mat-label>IBAN</mat-label>
                        <input matInput formControlName="iban" placeholder="IT00 0000 0000 0000 0000 0000 000">
                    </mat-form-field>

                    <mat-form-field class="w-full">
                        <mat-label>Numero Carta</mat-label>
                        <input matInput formControlName="numero_Carta" placeholder="**** **** **** ****">
                    </mat-form-field>

                    <mat-form-field class="w-full">
                        <mat-label>Data Scadenza</mat-label>
                        <input matInput formControlName="data_Scadenza" placeholder="MM/AA">
                    </mat-form-field>

                    <mat-form-field class="w-full">
                        <mat-label>PIN App</mat-label>
                        <input matInput type="password" formControlName="pin_App">
                        <button type="button" mat-icon-button matSuffix (click)="generatePin('pin_App')"
                            matTooltip="Genera PIN">
                            <mat-icon>autorenew</mat-icon>
                        </button>
                    </mat-form-field>

                    <mat-form-field class="w-full">
                        <mat-label>PIN Carta</mat-label>
                        <input matInput type="password" formControlName="pin_Carta">
                        <button type="button" mat-icon-button matSuffix (click)="generatePin('pin_Carta')"
                            matTooltip="Genera PIN">
                            <mat-icon>autorenew</mat-icon>
                        </button>
                    </mat-form-field>

                    <mat-form-field class="w-full">
                        <mat-label>PIN Generico</mat-label>
                        <input matInput type="password" formControlName="pin">
                        <button type="button" mat-icon-button matSuffix (click)="generatePin('pin')"
                            matTooltip="Genera PIN">
                            <mat-icon>autorenew</mat-icon>
                        </button>
                    </mat-form-field>

                    <mat-form-field class="w-full">
                        <mat-label>PUK</mat-label>
                        <input matInput formControlName="puk">
                        <button type="button" mat-icon-button matSuffix (click)="generatePuk()" matTooltip="Genera PUK">
                            <mat-icon>autorenew</mat-icon>
                        </button>
                    </mat-form-field>
                </div>
            </mat-tab>

            <!-- TAB 6: Sicurezza e Dispositivi -->
            <mat-tab label="Sicurezza e Dispositivi">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 py-4">
                    <mat-form-field class="w-full">
                        <mat-label>Codice Dispositivo</mat-label>
                        <input matInput formControlName="codice_Dispositivo">
                    </mat-form-field>

                    <mat-form-field class="w-full">
                        <mat-label>Codice Sicurezza</mat-label>
                        <input matInput formControlName="codice_Sicurezza">
                    </mat-form-field>

                    <div class="md:col-span-2">
                        <h4 class="text-lg font-medium mb-4 mt-4 text-gray-700">Informazioni Macchina</h4>
                    </div>

                    <mat-form-field class="w-full">
                        <mat-label>IP Macchina</mat-label>
                        <input matInput formControlName="machine_IP" placeholder="192.168.1.1">
                        <mat-error *ngIf="credentialForm.get('machine_IP')?.hasError('pattern')">
                            Inserisci un indirizzo IP valido
                        </mat-error>
                    </mat-form-field>

                    <mat-form-field class="w-full">
                        <mat-label>Nome Macchina</mat-label>
                        <input matInput formControlName="machine_Name">
                    </mat-form-field>

                    <mat-form-field class="w-full">
                        <mat-label>Tipo Macchina</mat-label>
                        <input matInput formControlName="machine_Type">
                    </mat-form-field>

                    <mat-form-field class="w-full">
                        <mat-label>Data Scadenza</mat-label>
                        <input matInput [matDatepicker]="picker" formControlName="expired_Date">
                        <mat-hint>Data di scadenza della credenziale</mat-hint>
                        <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
                        <mat-datepicker #picker></mat-datepicker>
                    </mat-form-field>
                </div>
            </mat-tab>

            <!-- TAB 7: Note e Stato -->
            <mat-tab label="Note e Stato">
                <div class="grid grid-cols-1 gap-4 py-4">
                    <mat-form-field class="w-full">
                        <mat-label>Note</mat-label>
                        <textarea matInput formControlName="note" rows="6"
                            placeholder="Inserisci note aggiuntive, informazioni particolari, etc."></textarea>
                    </mat-form-field>

                    <div class="flex flex-col gap-4 mt-4" *ngIf="isEditMode">
                        <h4 class="text-lg font-medium text-gray-700">Stato Credenziale</h4>

                        <mat-slide-toggle formControlName="active" color="primary">
                            <span class="ml-2">Credenziale Attiva</span>
                        </mat-slide-toggle>

                        <mat-slide-toggle formControlName="expired" color="warn">
                            <span class="ml-2">Credenziale Scaduta</span>
                        </mat-slide-toggle>
                    </div>
                </div>
            </mat-tab>

        </mat-tab-group>
    </div>

    <div mat-dialog-actions class="flex justify-end gap-2 p-4 border-t">
        <button mat-button type="button" (click)="onCancel()">Annulla</button>
        <button mat-raised-button color="primary" type="submit" [disabled]="credentialForm.invalid">
            {{ isEditMode ? 'Aggiorna' : 'Crea' }} Credenziale
        </button>
    </div>
</form>